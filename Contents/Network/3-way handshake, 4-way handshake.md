# 3-way handshake, 4-way handshake

---
## TCP 통신
> TCP 통신은 아래와 같은 **3단계의 과정**을 거친다.  

1. **Connection setup** (TCP 연결 초기화) - **3-way handshaking**  
2. **Data transfer** (데이터 전송)  
3. **Connection termination** (TCP 연결 종료) - **4-way handshaking**  

---
## 3-way handshaking  
> TCP/IP 프로토콜에서 통신을 시작하기 전, _신뢰할 수 있는 연결을 설정_ 하기 위해 사용하는 과정이다.<br><br>
> 이 과정은 **클라이언트와 서버 간의 연결을 확립**하는 과정으로, 총 **3단계(SYN → SYN+ACK → ACK)** 로 이루어진다.

<img width="655" alt="image" src="https://github.com/user-attachments/assets/46949890-6226-4228-952b-f98d03ca307e" />

### ✅ 과정
**1단계: 클라이언트 → 서버 (SYN 전송)**
  * **연결 요청** : _클라이언트가 연결을 요청하기 위해 SYN (Synchronize) 패킷을 서버로_ 보낸다.
  * 이 패킷에는 초기 시퀀스 번호(Initial Sequence Number, ISN) 가 포함되어 있다.
  * 서버가 이 요청을 수락하면 다음 단계로 진행된다.
<br>

**2단계: 서버 → 클라이언트 (SYN + ACK 응답)**
  * **연결 요청 승인 및 서버도 연결 요청** : 서버는 응답으로 _SYN + ACK (Acknowledge) 패킷을 클라이언트에게_ 보낸다.
    * SYN: 서버도 클라이언트와의 연결을 요청
    * ACK: 클라이언트의 SYN 요청을 승인
  * 이때, 서버는 자신의 초기 시퀀스 번호(ISN)를 포함한다.
<br>

**3단계: 클라이언트 → 서버 (ACK 전송)**
  * **연결 확립** : 클라이언트가 서버의 SYN + ACK 패킷을 수신한 후, _ACK (Acknowledgement) 패킷을 다시 서버로_ 보낸다.
<br>

-> 이로써, 클라이언트와 서버 간의 연결이 정상적으로 확립되고, 이후 데이터 전송이 가능해진다. 

### 목적
1. 신뢰성 있는 연결 확립: 데이터를 안정적으로 전송하기 위한 사전 작업
2. 양측의 전송 준비 확인: 클라이언트와 서버가 데이터 송수신을 준비할 시간을 제공
3. 초기 시퀀스 번호 교환: 데이터 전송의 순서를 보장하기 위해 시퀀스 번호(ISN) 설정

---

## 4-way handshaking  
> 4-way handshake는 TCP 연결 종료(Connection Termination) 를 위해 사용하는 과정이다. <br><br>
> TCP에서는 양방향(full-duplex) 통신을 제공하기 때문에, 연결을 끊기 위해서는 양쪽 모두 종료 요청을 보내야 하는데, 
> 이 과정은 **FIN → ACK → FIN → ACK** 의 총 4단계로 이루어진다.

<img width="695" alt="image" src="https://github.com/user-attachments/assets/90191620-2a15-440f-8040-baa6c597593c" />
> TCP connection termination(연결 종료)은 **양방향으로 2개의 연결이 독립적으로 단기** 때문에 **4단계**로 진행된다.  


### ✅ 과정
**1단계: 클라이언트 → 서버 (FIN 전송, 연결 종료 요청)**
  * **클라이언트가 연결 종료 요청** : _클라이언트가 더 이상 보낼 데이터가 없을 때, 연결 종료를 요청하기 위해 FIN (Finish) 패킷을 서버로_ 보낸다.
  * 이때, 서버는 아직 데이터를 보낼 수도 있기 때문에, 즉시 연결을 끊지는 않는다.
  * 서버는 FIN 요청을 수신한 후, 응답을 보낸다.
<br>

**2단계: 서버 → 클라이언트 (ACK 전송, FIN 요청 승인)**
  * **서버가 클라이언트의 종료 요청 승인** : 서버는 클라이언트의 FIN 패킷을 받으면, 이를 _인정(ACK) 하고 ACK (Acknowledgment) 패킷을 클라이언트에게_ 보낸다.
  * 이때, 서버는 아직 데이터 전송을 완료하지 않았을 수도 있으므로 연결을 유지한다.
    -> 이 경우, 클라이언트는 연결이 종료된 것이 아니라, 서버의 추가 데이터가 남아있는 상태임을 알고 대기한다.
<br>

**3단계: 서버 → 클라이언트 (ACK 전송, FIN 요청 승인)**
  * **서버도 연결 종료 요청** : 서버도 더 이상 보낼 데이터가 없으면 _클라이언트에게 FIN (Finish) 패킷을 전송하여 연결 종료를 요청_한다.
<br>

**4단계: 서버 → 클라이언트 (ACK 전송, FIN 요청 승인)**
  * **클라이언트가 서버의 종료 요청 승인** : 클라이언트는 서버의 FIN 요청을 수신한 후, 이를 _승인하는 ACK (Acknowledgment) 패킷을 서버로 전송_한다.
<br>

-> 이 단계가 끝나면 클라이언트와 서버의 연결이 완전히 종료된다.

## 목적
1. 데이터 손실 방지: 서버가 아직 전송할 데이터가 남아 있을 수 있으므로, 즉시 연결을 끊지 않고 데이터 전송을 마칠 시간을 줌
2. 양방향 연결 종료 보장: 클라이언트와 서버 모두 각자의 종료 요청을 따로 처리하여 안전하게 연결을 종료

---

### 💡면접 대비 핵심 포인트💡
## 1. 3-way handshake를 하는 목적
## 2. 각 step의 절차
✅ 3-way Handshake 
| 단계  | 송신자  | 수신자  | 패킷 종류  | 설명 |
|------|------|------|------|------|
| 1단계 | 클라이언트 | 서버 | SYN | 연결 요청 |
| 2단계 | 서버 | 클라이언트 | SYN + ACK | 연결 요청 승인 및 서버도 연결 요청 |
| 3단계 | 클라이언트 | 서버 | ACK | 연결 확립 완료 |

<br>

✅ 4-way Handshake
| 단계  | 송신자  | 수신자  | 패킷 종류  | 설명 |
|------|------|------|------|------|
| 1단계 | 클라이언트 | 서버 | FIN | 클라이언트가 연결 종료 요청 |
| 2단계 | 서버 | 클라이언트 | ACK | 서버가 클라이언트의 종료 요청 승인 |
| 3단계 | 서버 | 클라이언트 | FIN | 서버도 연결 종료 요청 |
| 4단계 | 클라이언트 | 서버 | ACK | 클라이언트가 서버의 종료 요청 승인 |
